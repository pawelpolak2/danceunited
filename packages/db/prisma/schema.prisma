// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client"
  engineType = "client"
  output     = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum UserRole {
  DANCER
  TRAINER
  MANAGER
}

enum DanceHall {
  HALL1
  HALL2
}

enum ClassStatus {
  ACTIVE
  CANCELLED
}

enum ClassLevel {
  OPEN
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum PurchaseStatus {
  ACTIVE
  EXPIRED
  USED
  CANCELLED
}

enum PaymentMethod {
  CARD
  CASH
  TRANSFER
  BLIK
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

// Models
model User {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstName    String   @map("first_name") @db.VarChar(100)
  lastName     String   @map("last_name") @db.VarChar(100)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  role         UserRole @default(DANCER)
  phoneNumber  String?  @map("phone_number") @db.VarChar(20)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  classTemplatesAsTrainer ClassTemplate[]  @relation("TemplateTrainer")
  classInstancesAsTrainer ClassInstance[]  @relation("InstanceTrainer")
  purchases               UserPurchase[]
  payments                Payment[]
  attendances             Attendance[]
  classWhitelists         ClassWhitelist[]

  @@map("user")
}

model DanceStyle {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String  @unique @db.VarChar(100)
  description String? @db.Text

  // Relations
  classTemplates ClassTemplate[]

  @@map("dance_style")
}

model ClassTemplate {
  id                 String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String     @db.VarChar(150)
  description        String?    @db.Text
  level              ClassLevel @default(OPEN)
  duration           Int        @default(3600) // Stored as seconds
  styleId            String     @map("style_id") @db.Uuid
  hallId             DanceHall  @default(HALL1) @map("hall_id")
  trainerId          String     @map("trainer_id") @db.Uuid
  isActive           Boolean    @default(true) @map("is_active")
  isWhitelistEnabled Boolean    @default(false) @map("is_whitelist_enabled")
  isIndividual       Boolean    @default(false) @map("is_individual")
  createdAt          DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  style          DanceStyle               @relation(fields: [styleId], references: [id])
  trainer        User                     @relation("TemplateTrainer", fields: [trainerId], references: [id])
  classInstances ClassInstance[]
  packageLinks   ClassTemplateToPackage[]
  whitelist      ClassWhitelist[]

  @@map("class_template")
}

model ClassWhitelist {
  userId          String @map("user_id") @db.Uuid
  classTemplateId String @map("class_template_id") @db.Uuid

  // Relations
  user          User          @relation(fields: [userId], references: [id])
  classTemplate ClassTemplate @relation(fields: [classTemplateId], references: [id])

  @@id([userId, classTemplateId])
  @@map("class_whitelist")
}

model ClassInstance {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  classTemplateId String      @map("class_template_id") @db.Uuid
  startTime       DateTime    @map("start_time") @db.Timestamptz(6)
  endTime         DateTime    @map("end_time") @db.Timestamptz(6)
  actualHall      DanceHall   @default(HALL1) @map("actual_hall")
  actualTrainerId String      @map("actual_trainer_id") @db.Uuid
  status          ClassStatus @default(ACTIVE)
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  // Relations
  classTemplate ClassTemplate @relation(fields: [classTemplateId], references: [id])
  actualTrainer User          @relation("InstanceTrainer", fields: [actualTrainerId], references: [id])
  attendances   Attendance[]

  @@map("classes")
}

model Attendance {
  userId  String @map("user_id") @db.Uuid
  classId String @map("class_id") @db.Uuid

  // Relations
  user  User          @relation(fields: [userId], references: [id])
  class ClassInstance @relation(fields: [classId], references: [id])

  @@id([userId, classId])
  @@map("attendance")
}

model Package {
  id           String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String          @db.VarChar(255)
  description  String?
  classCount   Int             @default(1) @map("class_count")
  price        Decimal         @db.Decimal(10, 2)
  validityDays Int             @default(30) @map("validity_days")
  isActive     Boolean         @default(true) @map("is_active")
  category     PackageCategory @default(UNIVERSAL)
  createdAt    DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  classLinks ClassTemplateToPackage[]
  purchases  UserPurchase[]

  @@map("package")
}

enum PackageCategory {
  YOUTH
  KIDS
  SPORT
  ADULTS
  UNIVERSAL
}

model ClassTemplateToPackage {
  classTemplateId String @map("class_template_id") @db.Uuid
  packageId       String @map("package_id") @db.Uuid

  // Relations
  classTemplate ClassTemplate @relation(fields: [classTemplateId], references: [id])
  package       Package       @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@id([classTemplateId, packageId])
  @@map("class_template_to_package")
}

model UserPurchase {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String         @map("user_id") @db.Uuid
  packageId        String         @map("package_id") @db.Uuid
  purchaseDate     DateTime       @default(now()) @map("purchase_date") @db.Timestamptz(6)
  expiryDate       DateTime?      @map("expiry_date") @db.Timestamptz(6)
  classesRemaining Int            @map("classes_remaining")
  classesUsed      Int            @default(0) @map("classes_used")
  paymentId        String?        @map("payment_id") @db.Uuid
  status           PurchaseStatus

  // Relations
  user    User     @relation(fields: [userId], references: [id])
  package Package  @relation(fields: [packageId], references: [id])
  payment Payment? @relation(fields: [paymentId], references: [id])

  @@map("user_purchase")
}

model Payment {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String        @map("user_id") @db.Uuid
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod @default(CARD) @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  transactionId String?       @map("transaction_id") @db.VarChar(255)
  paymentDate   DateTime      @default(now()) @map("payment_date") @db.Timestamptz(6)
  updatedAt     DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user          User           @relation(fields: [userId], references: [id])
  userPurchases UserPurchase[]

  @@map("payment")
}
